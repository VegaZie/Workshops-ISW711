<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabla de Cursos</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    button {
      padding: 4px 8px;
    }

    .form-container {
      width: 300px;
      margin: 20px auto;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .form-group input {
      width: 100%;
      padding: 5px;
    }

    .form-group button {
      padding: 5px 10px;
    }
  </style>
</head>
</head>
<body>
  <div>
    <table id="coursesTable">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Créditos</th>
          <th>Profesor</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="form-container">
    <h2>Crear Curso</h2>
    <div class="form-group">
      <label for="nameInput">Nombre:</label>
      <input type="text" id="nameInput">
    </div>
    <div class="form-group">
      <label for="creditsInput">Créditos:</label>
      <input type="number" id="creditsInput">
    </div>
    <div class="form-group">
      <button id="createButton">Crear</button>
    </div>
  </div>

  <script>
    function getCourses() {
      const ajaxRequest = new XMLHttpRequest();
      ajaxRequest.addEventListener("load", completed);
      ajaxRequest.addEventListener("error", error);
      ajaxRequest.open("GET", "http://localhost:3001/api/courses");
      ajaxRequest.send();
    }

    function completed(event) {
      const response = JSON.parse(event.target.responseText);
      const tableBody = document.querySelector("#coursesTable tbody");

      // Limpiar la tabla antes de actualizarla
      tableBody.innerHTML = "";

      // Recorrer los cursos y agregar filas a la tabla
      response.forEach(course => {
        const row = document.createElement("tr");
        const idTr = course._id;
        console.log(idTr);
        row.id = idTr;

        // Crear celdas para cada propiedad del curso
        const nameCell = document.createElement("td");
        nameCell.textContent = course.name;
        row.appendChild(nameCell);

        const creditsCell = document.createElement("td");
        creditsCell.textContent = course.credits;
        row.appendChild(creditsCell);

        const teacherCell = document.createElement("td");
        if (course.teacher === undefined){
          teacherCell.textContent = "Sin asignar";
        }
        else {
          teacherCell.textContent = course.teacher.first_name + " " + course.teacher.last_name;
        }
        row.appendChild(teacherCell);

        // Crear celda de acciones con botones de editar y eliminar
        const actionsCell = document.createElement("td");
        const editButton = document.createElement("button");
        editButton.textContent = "Editar";
        editButton.addEventListener("click", () => {
          editCourse(course);
        });
        actionsCell.appendChild(editButton);

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Eliminar";
        deleteButton.addEventListener("click", () => {
          deleteCourse(course._id);
        });
        actionsCell.appendChild(deleteButton);

        row.appendChild(actionsCell);

        tableBody.appendChild(row);
      });
    }

    function deleteCourse(courseId) {
      const ajaxRequest = new XMLHttpRequest();
      ajaxRequest.addEventListener("load", completedDelete);
      ajaxRequest.addEventListener("error", error);
      ajaxRequest.open("DELETE", `http://localhost:3001/api/courses?id=${courseId}`);
      ajaxRequest.send();
    }

    function completedDelete(event) {
      // Lógica para manejar la respuesta del servidor después de eliminar el curso
      console.log("Curso eliminado:", event.target.responseText);
      // Volver a obtener la lista de cursos después de eliminar uno
      getCourses();
    }

    function error(event) {
      console.error("Error en la solicitud AJAX:", event.target.status);
    }

    function postCourses() {
      const ajaxRequest = new XMLHttpRequest();
      ajaxRequest.addEventListener("load", completedPost);
      ajaxRequest.addEventListener("error", error);
      ajaxRequest.open("POST", "http://localhost:3001/api/courses");

      // Obtener los valores de los campos de entrada
      const name = document.querySelector("#nameInput").value;
      const credits = document.querySelector("#creditsInput").value;

      // Crear el objeto del curso a enviar
      const course = {
        name: name,
        credits: credits,
      };

      // Convertir el objeto a JSON y establecer la cabecera de la solicitud
      ajaxRequest.setRequestHeader("Content-Type", "application/json");
      ajaxRequest.send(JSON.stringify(course));
    }

    function completedPost(event) {
      // Lógica para manejar la respuesta del servidor después de crear el curso
      console.log("Curso creado:", event.target.responseText);
      getCourses();
    }


    // Asignar el evento click al botón de crear
    document.querySelector("#createButton").addEventListener("click", postCourses);


    function editCourse(course) {
      // Obtener los valores actuales del curso
      const currentName = course.name;
      const currentCredits = course.credits;
      const currentTeacher = course.teacher;

      // Crear un formulario para editar el curso
      const form = document.createElement("form");

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = currentName;
      form.appendChild(nameInput);

      const creditsInput = document.createElement("input");
      creditsInput.type = "number";
      creditsInput.value = currentCredits;
      form.appendChild(creditsInput);

      const teacherInput = document.createElement("input");
      teacherInput.type = "text";
      teacherInput.value = currentTeacher;
      form.appendChild(teacherInput);

      const saveButton = document.createElement("button");
      saveButton.textContent = "Guardar";
      form.appendChild(saveButton);

      // Agregar evento de submit al formulario
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        updateCourse(course._id, nameInput.value, creditsInput.value, teacherInput.value);
      });

      // Reemplazar la fila actual con el formulario de edición
      const row = document.querySelector(`tr[data-id="${course._id}"]`);
      row.innerHTML = "";
      const cell = document.createElement("td");
      cell.colSpan = 4;
      cell.appendChild(form);
      row.appendChild(cell);
    }

    function updateCourse(courseId, newName, newCredits, newTeacher) {
      const ajaxRequest = new XMLHttpRequest();
      ajaxRequest.addEventListener("load", completedUpdate);
      ajaxRequest.addEventListener("error", error);
      ajaxRequest.open("PATCH", `http://localhost:3001/api/courses?id=${courseId}`);
      ajaxRequest.setRequestHeader("Content-Type", "application/json");

      const data = {
        name: newName,
        credits: newCredits,
        teacher: newTeacher
      };

      ajaxRequest.send(JSON.stringify(data));
    }

    function completedUpdate(event) {
      // Lógica para manejar la respuesta del servidor después de actualizar el curso
      console.log("Curso actualizado:", event.target.responseText);
      // Puedes realizar otras acciones aquí, como mostrar un mensaje de éxito o actualizar la tabla de cursos
      // Volver a obtener la lista de cursos después de actualizar uno
      getCourses();
    }

    getCourses();
  </script>
</body>
</html>